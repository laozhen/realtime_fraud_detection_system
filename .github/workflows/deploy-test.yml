name: Deploy to Test Environment

on:
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Optional: Override version (leave empty to auto-generate)'
        required: false
        type: string

env:
  JAVA_VERSION: '21'
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

jobs:
  generate-version:
    name: Generate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      docker_tag: ${{ steps.version.outputs.docker_tag }}
      helm_version: ${{ steps.version.outputs.helm_version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate version information
        id: version
        run: |
          # Check if version override is provided
          if [ -n "${{ inputs.version_override }}" ]; then
            VERSION="${{ inputs.version_override }}"
            DOCKER_TAG="${VERSION}"
            HELM_VERSION="${VERSION}"
            SHORT_SHA=$(git rev-parse --short=7 HEAD)
            echo "Using override version: ${VERSION}"
          else
            # Get short SHA
            SHORT_SHA=$(git rev-parse --short=7 HEAD)
            
            # Get timestamp for unique versioning
            TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
            
            # Base version from build.gradle
            BASE_VERSION="1.0.0"
            if [ -f "build.gradle" ]; then
              BASE_VERSION=$(grep "version = " build.gradle | cut -d "'" -f 2 | head -1)
            fi
            
            # Generate test environment version
            VERSION="${BASE_VERSION}-test.${SHORT_SHA}"
            DOCKER_TAG="${VERSION}"
            HELM_VERSION="${BASE_VERSION}-test.${SHORT_SHA}"
            
            echo "Generated version: ${VERSION}"
          fi
          
          # Output all version information
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "docker_tag=${DOCKER_TAG}" >> $GITHUB_OUTPUT
          echo "helm_version=${HELM_VERSION}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          
          # Display version information
          echo "========================================"
          echo "üì¶ Version Information for TEST"
          echo "========================================"
          echo "  Full Version: ${VERSION}"
          echo "  Docker Tag:   ${DOCKER_TAG}"
          echo "  Helm Version: ${HELM_VERSION}"
          echo "  Short SHA:    ${SHORT_SHA}"
          echo "  Environment:  test"
          echo "========================================"
  
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: generate-version
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Build and publish Docker images using Gradle/Jib
        env:
          DOCKER_REGISTRY: ${{ env.IMAGE_PREFIX }}
          DOCKER_USERNAME: ${{ github.actor }}
          DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_TAG: ${{ needs.generate-version.outputs.docker_tag }}
        run: |
          echo "üê≥ Building and publishing Docker images for test environment..."
          echo "   Version: ${{ needs.generate-version.outputs.version }}"
          echo "   Docker Tag: ${{ needs.generate-version.outputs.docker_tag }}"
          ./gradlew publishAllImages --no-daemon
          echo "‚úÖ Successfully published all Docker images with tag: ${{ needs.generate-version.outputs.docker_tag }}"
  
  package-helm-charts:
    name: Package Helm Charts
    runs-on: ubuntu-latest
    needs: [generate-version, build-and-push]
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'
      
      - name: Update Helm chart versions and image tags
        run: |
          # Update fraud-detection chart
          sed -i "s/^version:.*/version: ${{ needs.generate-version.outputs.helm_version }}/" helm/fraud-detection/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ needs.generate-version.outputs.docker_tag }}\"/" helm/fraud-detection/Chart.yaml
          sed -i "s/tag:.*/tag: \"${{ needs.generate-version.outputs.docker_tag }}\"/" helm/fraud-detection/values.yaml
          
          # Update transaction-producer chart
          sed -i "s/^version:.*/version: ${{ needs.generate-version.outputs.helm_version }}/" helm/transaction-producer/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ needs.generate-version.outputs.docker_tag }}\"/" helm/transaction-producer/Chart.yaml
          sed -i "s/tag:.*/tag: \"${{ needs.generate-version.outputs.docker_tag }}\"/" helm/transaction-producer/values.yaml
          
          echo "üì¶ Updated Helm charts to version ${{ needs.generate-version.outputs.helm_version }}"
          echo "üè∑Ô∏è  Set image tag to ${{ needs.generate-version.outputs.docker_tag }}"
      
      - name: Package Helm charts
        run: |
          helm package helm/fraud-detection --version ${{ needs.generate-version.outputs.helm_version }} --app-version ${{ needs.generate-version.outputs.docker_tag }}
          helm package helm/transaction-producer --version ${{ needs.generate-version.outputs.helm_version }} --app-version ${{ needs.generate-version.outputs.docker_tag }}
          
          echo "‚úÖ Packaged Helm charts"
      
      - name: Log in to Helm registry
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ${{ env.REGISTRY }} --username ${{ github.actor }} --password-stdin
      
      - name: Push Helm charts to registry
        run: |
          helm push fraud-detection-${{ needs.generate-version.outputs.helm_version }}.tgz oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/helm-charts
          helm push transaction-producer-${{ needs.generate-version.outputs.helm_version }}.tgz oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/helm-charts
          
          echo "‚úÖ Published Helm charts to registry"
  
  deploy-test-aws:
    name: Deploy to AWS Test
    runs-on: ubuntu-latest
    needs: [generate-version, build-and-push, package-helm-charts]
    environment:
      name: test-aws
      url: https://fraud-detection-test.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig --name fraud-detection-cluster-test --region us-east-1
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'
      
      - name: Update Helm chart image tags
        run: |
          sed -i "s/tag:.*/tag: \"${{ needs.generate-version.outputs.docker_tag }}\"/" helm/fraud-detection/values.yaml
          sed -i "s/tag:.*/tag: \"${{ needs.generate-version.outputs.docker_tag }}\"/" helm/transaction-producer/values.yaml
      
      - name: Deploy fraud-detection-service
        run: |
          helm upgrade --install fraud-detection ./helm/fraud-detection \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-aws-test.yaml \
            --set image.tag=${{ needs.generate-version.outputs.docker_tag }} \
            --set-string version=${{ needs.generate-version.outputs.version }} \
            --wait \
            --timeout 5m
          
          echo "‚úÖ Deployed fraud-detection-service version ${{ needs.generate-version.outputs.version }}"
      
      - name: Deploy transaction-producer
        run: |
          helm upgrade --install transaction-producer ./helm/transaction-producer \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-aws-test.yaml \
            --set image.tag=${{ needs.generate-version.outputs.docker_tag }} \
            --set-string version=${{ needs.generate-version.outputs.version }} \
            --wait \
            --timeout 5m
          
          echo "‚úÖ Deployed transaction-producer version ${{ needs.generate-version.outputs.version }}"
      
      - name: Run smoke tests
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=fraud-detection \
            -n fraud-detection --timeout=300s
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=transaction-producer \
            -n fraud-detection --timeout=300s
      
      - name: Verify deployment
        run: |
          kubectl get pods -n fraud-detection
          kubectl get svc -n fraud-detection
  
  deploy-test-gcp:
    name: Deploy to GCP Test
    runs-on: ubuntu-latest
    needs: [generate-version, build-and-push, package-helm-charts]
    environment:
      name: test-gcp
      url: https://fraud-detection-test-gcp.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure kubectl for GKE
        run: |
          gcloud container clusters get-credentials fraud-detection-cluster-test \
            --region us-central1 \
            --project ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'
      
      - name: Update Helm chart image tags
        run: |
          sed -i "s/tag:.*/tag: \"${{ needs.generate-version.outputs.docker_tag }}\"/" helm/fraud-detection/values.yaml
          sed -i "s/tag:.*/tag: \"${{ needs.generate-version.outputs.docker_tag }}\"/" helm/transaction-producer/values.yaml
      
      - name: Deploy fraud-detection-service
        run: |
          helm upgrade --install fraud-detection ./helm/fraud-detection \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-gcp-test.yaml \
            --set image.tag=${{ needs.generate-version.outputs.docker_tag }} \
            --set-string version=${{ needs.generate-version.outputs.version }} \
            --wait \
            --timeout 5m
          
          echo "‚úÖ Deployed fraud-detection-service version ${{ needs.generate-version.outputs.version }}"
      
      - name: Deploy transaction-producer
        run: |
          helm upgrade --install transaction-producer ./helm/transaction-producer \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-gcp-test.yaml \
            --set image.tag=${{ needs.generate-version.outputs.docker_tag }} \
            --set-string version=${{ needs.generate-version.outputs.version }} \
            --wait \
            --timeout 5m
          
          echo "‚úÖ Deployed transaction-producer version ${{ needs.generate-version.outputs.version }}"
      
      - name: Run smoke tests
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=fraud-detection \
            -n fraud-detection --timeout=300s
      
      - name: Verify deployment
        run: |
          kubectl get pods -n fraud-detection
          kubectl get svc -n fraud-detection
          
          echo "========================================"
          echo "üéâ Deployment Summary"
          echo "========================================"
          echo "  Version: ${{ needs.generate-version.outputs.version }}"
          echo "  Docker Tag: ${{ needs.generate-version.outputs.docker_tag }}"
          echo "  Helm Version: ${{ needs.generate-version.outputs.helm_version }}"
          echo "  Environment: test-gcp"
          echo "========================================"

