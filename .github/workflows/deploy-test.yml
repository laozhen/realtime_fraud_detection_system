name: Deploy to Test Environment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Generate version
        id: version
        run: |
          VERSION=${GITHUB_SHA}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
      
      - name: Build and publish Docker images using Gradle/Jib
        env:
          DOCKER_REGISTRY: ${{ env.IMAGE_PREFIX }}
          DOCKER_USERNAME: ${{ github.actor }}
          DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_TAG: ${{ steps.version.outputs.version }}
        run: |
          echo "Building and publishing Docker images for test environment..."
          ./gradlew publishAllImages --no-daemon
          echo "âœ… Successfully published all Docker images with tags: ${{ steps.version.outputs.version }}, latest"
  
  deploy-test-aws:
    name: Deploy to AWS Test
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: test-aws
      url: https://fraud-detection-test.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig --name fraud-detection-cluster-test --region us-east-1
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'
      
      - name: Deploy fraud-detection-service
        run: |
          helm upgrade --install fraud-detection ./helm/fraud-detection \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-aws-test.yaml \
            --set image.tag=${{ needs.build-and-push.outputs.version }} \
            --wait \
            --timeout 5m
      
      - name: Deploy transaction-producer
        run: |
          helm upgrade --install transaction-producer ./helm/transaction-producer \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-aws-test.yaml \
            --set image.tag=${{ needs.build-and-push.outputs.version }} \
            --wait \
            --timeout 5m
      
      - name: Run smoke tests
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=fraud-detection \
            -n fraud-detection --timeout=300s
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=transaction-producer \
            -n fraud-detection --timeout=300s
      
      - name: Verify deployment
        run: |
          kubectl get pods -n fraud-detection
          kubectl get svc -n fraud-detection
  
  deploy-test-gcp:
    name: Deploy to GCP Test
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: test-gcp
      url: https://fraud-detection-test-gcp.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure kubectl for GKE
        run: |
          gcloud container clusters get-credentials fraud-detection-cluster-test \
            --region us-central1 \
            --project ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'
      
      - name: Deploy fraud-detection-service
        run: |
          helm upgrade --install fraud-detection ./helm/fraud-detection \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-gcp-test.yaml \
            --set image.tag=${{ needs.build-and-push.outputs.version }} \
            --wait \
            --timeout 5m
      
      - name: Deploy transaction-producer
        run: |
          helm upgrade --install transaction-producer ./helm/transaction-producer \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-gcp-test.yaml \
            --set image.tag=${{ needs.build-and-push.outputs.version }} \
            --wait \
            --timeout 5m
      
      - name: Run smoke tests
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=fraud-detection \
            -n fraud-detection --timeout=300s
      
      - name: Verify deployment
        run: |
          kubectl get pods -n fraud-detection
          kubectl get svc -n fraud-detection

