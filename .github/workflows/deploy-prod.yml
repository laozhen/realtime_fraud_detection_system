name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.0.0-test.abc1234 or semantic version like 1.2.3)'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - prod-aws
      create_release_tag:
        description: 'Create a git release tag for this production deployment'
        required: false
        type: boolean
        default: true

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.validate.outputs.docker_tag }}
      is_valid: ${{ steps.validate.outputs.is_valid }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ inputs.version }}"
          
          # Check if version exists in container registry
          echo "Validating version: ${VERSION}"
          
          # Set docker tag (same as version for production)
          echo "docker_tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "is_valid=true" >> $GITHUB_OUTPUT
          
          echo "âœ… Version ${VERSION} is valid"
  
  approve:
    name: Manual Approval
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Display deployment information
        run: |
          echo "========================================"
          echo "ðŸš€ Production Deployment Request"
          echo "========================================"
          echo "  Version: ${{ inputs.version }}"
          echo "  Environment: ${{ inputs.environment }}"
          echo "  Create Release Tag: ${{ inputs.create_release_tag }}"
          echo "========================================"
          echo ""
          echo "âš ï¸  This deployment requires manual approval."
          echo "Please review the version and environment before approving."
      
      - name: Wait for approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: platform-team,security-team
          minimum-approvals: 2
          issue-title: "ðŸš€ Deploy version ${{ inputs.version }} to ${{ inputs.environment }}"
          issue-body: |
            ## Production Deployment Approval Request
            
            **Version**: `${{ inputs.version }}`
            **Environment**: `${{ inputs.environment }}`
            **Create Release Tag**: `${{ inputs.create_release_tag }}`
            **Triggered By**: @${{ github.actor }}
            **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ### Pre-Deployment Checklist
            - [ ] Version has been tested in test environment
            - [ ] All smoke tests passed
            - [ ] Security scan completed
            - [ ] Rollback plan reviewed
            - [ ] On-call team notified
            
            **Please approve this deployment if all checks pass.**
  
  create-release-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    needs: [validate-version, approve]
    if: ${{ inputs.create_release_tag == true }}
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create and push release tag
        run: |
          VERSION="${{ inputs.version }}"
          TAG_NAME="release-${VERSION}"
          
          # Create annotated tag
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git tag -a "${TAG_NAME}" -m "Production release ${VERSION} to ${{ inputs.environment }}"
          git push origin "${TAG_NAME}"
          
          echo "âœ… Created release tag: ${TAG_NAME}"
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release-${{ inputs.version }}
          release_name: Production Release ${{ inputs.version }}
          body: |
            ## Production Deployment
            
            **Version**: `${{ inputs.version }}`
            **Environment**: `${{ inputs.environment }}`
            **Deployed By**: @${{ github.actor }}
            **Deployment Date**: ${{ github.event.repository.updated_at }}
            
            ### Deployment Details
            - Docker Images: Tagged with `${{ needs.validate-version.outputs.docker_tag }}`
            - Helm Charts: Version `${{ inputs.version }}`
            
            ### Deployed Services
            - fraud-detection-service
            - transaction-producer
          draft: false
          prerelease: false
  
  deploy-prod-aws:
    name: Deploy to AWS Production
    runs-on: ubuntu-latest
    needs: [validate-version, approve]
    if: ${{ inputs.environment == 'prod-aws' }}
    environment:
      name: prod-aws
      url: https://fraud-detection.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: us-east-1
      
      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig --name fraud-detection-cluster-prod --region us-east-1
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'
      
      - name: Log in to Helm registry
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ghcr.io --username ${{ github.actor }} --password-stdin
      
      - name: Create backup of current deployment
        run: |
          echo "ðŸ“¦ Creating backup of current deployment..."
          helm get values fraud-detection -n fraud-detection > backup-fraud-detection.yaml || true
          helm get values transaction-producer -n fraud-detection > backup-transaction-producer.yaml || true
          
          # Get current versions
          CURRENT_FRAUD_VERSION=$(helm list -n fraud-detection -o json | jq -r '.[] | select(.name=="fraud-detection") | .app_version' || echo "none")
          CURRENT_PRODUCER_VERSION=$(helm list -n fraud-detection -o json | jq -r '.[] | select(.name=="transaction-producer") | .app_version' || echo "none")
          
          echo "Current fraud-detection version: ${CURRENT_FRAUD_VERSION}"
          echo "Current transaction-producer version: ${CURRENT_PRODUCER_VERSION}"
          echo "New version: ${{ inputs.version }}"
      
      - name: Pull Helm charts from registry
        run: |
          echo "ðŸ“¦ Pulling pre-built Helm charts from registry..."
          helm pull oci://ghcr.io/${{ github.repository_owner }}/helm-charts/fraud-detection --version ${{ inputs.version }}
          helm pull oci://ghcr.io/${{ github.repository_owner }}/helm-charts/transaction-producer --version ${{ inputs.version }}
          
          echo "âœ… Successfully pulled Helm charts version ${{ inputs.version }}"
      
      - name: Deploy fraud-detection-service
        id: deploy-fraud
        run: |
          echo "ðŸš€ Deploying fraud-detection-service version ${{ inputs.version }} to AWS Production..."
          helm upgrade --install fraud-detection oci://ghcr.io/${{ github.repository_owner }}/helm-charts/fraud-detection \
            --version ${{ inputs.version }} \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-aws-prod.yaml \
            --set image.tag=${{ needs.validate-version.outputs.docker_tag }} \
            --set-string version=${{ inputs.version }} \
            --wait \
            --timeout 10m \
            --atomic \
            --cleanup-on-fail
          
          echo "âœ… Successfully deployed fraud-detection-service"
      
      - name: Deploy transaction-producer
        id: deploy-producer
        run: |
          echo "ðŸš€ Deploying transaction-producer version ${{ inputs.version }} to AWS Production..."
          helm upgrade --install transaction-producer oci://ghcr.io/${{ github.repository_owner }}/helm-charts/transaction-producer \
            --version ${{ inputs.version }} \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-aws-prod.yaml \
            --set image.tag=${{ needs.validate-version.outputs.docker_tag }} \
            --set-string version=${{ inputs.version }} \
            --wait \
            --timeout 10m \
            --atomic \
            --cleanup-on-fail
          
          echo "âœ… Successfully deployed transaction-producer"
      
      - name: Run health checks
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=fraud-detection \
            -n fraud-detection --timeout=600s
          
          # Check pod status
          kubectl get pods -n fraud-detection
          
          # Test endpoints
          kubectl run curl-test --image=curlimages/curl:latest --rm -i --restart=Never \
            -- curl -f http://fraud-detection.fraud-detection:8080/actuator/health
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          helm rollback fraud-detection -n fraud-detection || true
          helm rollback transaction-producer -n fraud-detection || true
      
      - name: Notify deployment status
        if: always()
        run: |
          echo "Deployment status: ${{ job.status }}"
          # Add notification logic here (Slack, Email, PagerDuty, etc.)
  