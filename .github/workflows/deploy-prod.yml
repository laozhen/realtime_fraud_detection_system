name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Image version to deploy'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - prod-aws
          - prod-gcp
          - both

jobs:
  approve:
    name: Manual Approval
    runs-on: ubuntu-latest
    steps:
      - name: Wait for approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: platform-team,security-team
          minimum-approvals: 2
          issue-title: "Deploy version ${{ inputs.version }} to production"
  
  deploy-prod-aws:
    name: Deploy to AWS Production
    runs-on: ubuntu-latest
    needs: approve
    if: ${{ inputs.environment == 'prod-aws' || inputs.environment == 'both' }}
    environment:
      name: prod-aws
      url: https://fraud-detection.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: us-east-1
      
      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig --name fraud-detection-cluster-prod --region us-east-1
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'
      
      - name: Create backup of current deployment
        run: |
          helm get values fraud-detection -n fraud-detection > backup-fraud-detection.yaml || true
          helm get values transaction-producer -n fraud-detection > backup-transaction-producer.yaml || true
      
      - name: Deploy fraud-detection-service
        id: deploy-fraud
        run: |
          helm upgrade --install fraud-detection ./helm/fraud-detection \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-aws-prod.yaml \
            --set image.tag=${{ inputs.version }} \
            --wait \
            --timeout 10m \
            --atomic \
            --cleanup-on-fail
      
      - name: Deploy transaction-producer
        id: deploy-producer
        run: |
          helm upgrade --install transaction-producer ./helm/transaction-producer \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-aws-prod.yaml \
            --set image.tag=${{ inputs.version }} \
            --wait \
            --timeout 10m \
            --atomic \
            --cleanup-on-fail
      
      - name: Run health checks
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=fraud-detection \
            -n fraud-detection --timeout=600s
          
          # Check pod status
          kubectl get pods -n fraud-detection
          
          # Test endpoints
          kubectl run curl-test --image=curlimages/curl:latest --rm -i --restart=Never \
            -- curl -f http://fraud-detection.fraud-detection:8080/actuator/health
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          helm rollback fraud-detection -n fraud-detection || true
          helm rollback transaction-producer -n fraud-detection || true
      
      - name: Notify deployment status
        if: always()
        run: |
          echo "Deployment status: ${{ job.status }}"
          # Add notification logic here (Slack, Email, PagerDuty, etc.)
  
  deploy-prod-gcp:
    name: Deploy to GCP Production
    runs-on: ubuntu-latest
    needs: approve
    if: ${{ inputs.environment == 'prod-gcp' || inputs.environment == 'both' }}
    environment:
      name: prod-gcp
      url: https://fraud-detection-gcp.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_PROD }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure kubectl for GKE
        run: |
          gcloud container clusters get-credentials fraud-detection-cluster-prod \
            --region us-central1 \
            --project ${{ secrets.GCP_PROJECT_ID_PROD }}
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'
      
      - name: Create backup of current deployment
        run: |
          helm get values fraud-detection -n fraud-detection > backup-fraud-detection.yaml || true
      
      - name: Deploy fraud-detection-service
        run: |
          helm upgrade --install fraud-detection ./helm/fraud-detection \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-gcp-prod.yaml \
            --set image.tag=${{ inputs.version }} \
            --wait \
            --timeout 10m \
            --atomic \
            --cleanup-on-fail
      
      - name: Deploy transaction-producer
        run: |
          helm upgrade --install transaction-producer ./helm/transaction-producer \
            --namespace fraud-detection \
            --create-namespace \
            --values ./helm/values-gcp-prod.yaml \
            --set image.tag=${{ inputs.version }} \
            --wait \
            --timeout 10m \
            --atomic \
            --cleanup-on-fail
      
      - name: Run health checks
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=fraud-detection \
            -n fraud-detection --timeout=600s
          kubectl get pods -n fraud-detection
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          helm rollback fraud-detection -n fraud-detection || true
          helm rollback transaction-producer -n fraud-detection || true