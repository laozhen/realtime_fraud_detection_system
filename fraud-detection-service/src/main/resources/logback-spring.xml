<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    
    <springProperty scope="context" name="springAppName" source="spring.application.name"/>
    <springProperty scope="context" name="awsRegion" source="cloud.aws.region" defaultValue="us-east-1"/>
    <springProperty scope="context" name="environment" source="ENVIRONMENT" defaultValue="test"/>
    <springProperty scope="context" name="logGroup" source="logging.cloudwatch.log-group" defaultValue="/aws/fraud-detection/${environment}/fraud-detection-service"/>
    <springProperty scope="context" name="logStream" source="logging.cloudwatch.log-stream" defaultValue="application"/>
    <springProperty scope="context" name="gcpProjectId" source="cloud.gcp.project-id" defaultValue=""/>
    <springProperty scope="context" name="gcpLogName" source="logging.stackdriver.log-name" defaultValue="fraud-detection-service"/>
    
    <!-- Console appender with JSON format for cloud-native logging -->
    <appender name="CONSOLE_JSON" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <fieldNames>
                <timestamp>timestamp</timestamp>
                <message>message</message>
                <logger>logger</logger>
                <level>level</level>
                <thread>thread</thread>
                <stackTrace>stackTrace</stackTrace>
            </fieldNames>
            <customFields>{"service":"${springAppName}"}</customFields>
            <!-- Include MDC fields for distributed tracing -->
            <includeMdcKeyName>correlationId</includeMdcKeyName>
            <includeMdcKeyName>traceId</includeMdcKeyName>
            <includeMdcKeyName>spanId</includeMdcKeyName>
            <includeMdcKeyName>transactionId</includeMdcKeyName>
            <includeMdcKeyName>accountId</includeMdcKeyName>
            <includeMdcKeyName>userId</includeMdcKeyName>
            <includeMdcKeyName>serviceName</includeMdcKeyName>
            <includeMdcKeyName>cloudProvider</includeMdcKeyName>
            <includeMdcKeyName>environment</includeMdcKeyName>
            <includeMdcKeyName>alertId</includeMdcKeyName>
            <includeMdcKeyName>severity</includeMdcKeyName>
        </encoder>
    </appender>
    
    <!-- Console appender with plain text for local development -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%X{correlationId}] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- Local development profile -->
    <springProfile name="local">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
        <logger name="com.hsbc.fraud" level="DEBUG"/>
    </springProfile>
    
    <!-- AWS profile with CloudWatch integration -->
    <springProfile name="aws">
        <!-- AWS CloudWatch Logs Appender -->
        <appender name="CLOUDWATCH" class="ca.pjer.logback.AwsLogsAppender">
            <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
                <level>INFO</level>
            </filter>
            <layout>
                <pattern>[%thread] [%X{correlationId}] %-5level %logger{36} - %msg%n</pattern>
            </layout>
            <logGroupName>${logGroup}</logGroupName>
            <logStreamName>${logStream}</logStreamName>
            <logRegion>${awsRegion}</logRegion>
            <maxBatchLogEvents>50</maxBatchLogEvents>
            <maxFlushTimeMillis>30000</maxFlushTimeMillis>
            <maxBlockTimeMillis>5000</maxBlockTimeMillis>
            <!-- Retention is managed by Terraform CloudWatch log group configuration -->
        </appender>
        
        <!-- Async wrapper for CloudWatch to prevent blocking -->
        <appender name="ASYNC_CLOUDWATCH" class="ch.qos.logback.classic.AsyncAppender">
            <queueSize>500</queueSize>
            <discardingThreshold>0</discardingThreshold>
            <appender-ref ref="CLOUDWATCH"/>
            <includeCallerData>false</includeCallerData>
        </appender>
        
        <root level="INFO">
            <appender-ref ref="CONSOLE_JSON"/>
            <appender-ref ref="ASYNC_CLOUDWATCH"/>
        </root>
        <logger name="com.hsbc.fraud" level="INFO"/>
        <logger name="com.amazonaws" level="WARN"/>
        <logger name="software.amazon.awssdk" level="WARN"/>
    </springProfile>
    
    <!-- GCP profile with Stackdriver/Cloud Logging integration -->
    <springProfile name="gcp">
        <!-- GCP Stackdriver (Cloud Logging) Appender -->
        <appender name="STACKDRIVER" class="com.google.cloud.logging.logback.LoggingAppender">
            <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
                <level>INFO</level>
            </filter>
            <log>${gcpLogName}</log>
            <resourceType>k8s_container</resourceType>
            <flushLevel>INFO</flushLevel>
            <enhancer>com.google.cloud.logging.logback.LoggingEnhancer</enhancer>
            <loggingEventEnhancer>com.google.cloud.logging.logback.LoggingEventEnhancer</loggingEventEnhancer>
        </appender>
        
        <!-- Async wrapper for Stackdriver to prevent blocking -->
        <appender name="ASYNC_STACKDRIVER" class="ch.qos.logback.classic.AsyncAppender">
            <queueSize>500</queueSize>
            <discardingThreshold>0</discardingThreshold>
            <appender-ref ref="STACKDRIVER"/>
            <includeCallerData>false</includeCallerData>
        </appender>
        
        <root level="INFO">
            <appender-ref ref="CONSOLE_JSON"/>
            <appender-ref ref="ASYNC_STACKDRIVER"/>
        </root>
        <logger name="com.hsbc.fraud" level="INFO"/>
        <logger name="com.google.cloud" level="WARN"/>
    </springProfile>
    
    <!-- Test profile -->
    <springProfile name="test">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
        <logger name="com.hsbc.fraud" level="DEBUG"/>
    </springProfile>
    
    <!-- AWS Integration Test profile (with LocalStack, no real CloudWatch) -->
    <springProfile name="aws-test">
        <root level="INFO">
            <appender-ref ref="CONSOLE_JSON"/>
        </root>
        <logger name="com.hsbc.fraud" level="DEBUG"/>
        <logger name="com.amazonaws" level="WARN"/>
        <logger name="software.amazon.awssdk" level="WARN"/>
    </springProfile>
    
</configuration>

